<!DOCTYPE html><html><head><title>guardrail: Generating a Server - akka-http - scala - guardrail</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="guardrail.dev" /><meta name="description" content="Principled code generation from OpenAPI specifications" /><meta name="og:image" content="/./img/poster.png" /><meta name="image" property="og:image" content="/./img/poster.png" /><meta name="og:title" content="guardrail: Generating a Server - akka-http - scala - guardrail" /><meta name="title" property="og:title" content="guardrail: Generating a Server - akka-http - scala - guardrail" /><meta name="og:site_name" content="guardrail" /><meta name="og:url" content="https://github.com/guardrail-dev/guardrail" /><meta name="og:type" content="website" /><meta name="og:description" content="Principled code generation from OpenAPI specifications" /><link rel="icon" type="image/png" href="/./img/favicon.png" /><meta name="twitter:title" content="guardrail: Generating a Server - akka-http - scala - guardrail" /><meta name="twitter:image" content="https://guardrail.dev//./img/poster.png" /><meta name="twitter:description" content="Principled code generation from OpenAPI specifications" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:site" content="@guardrail_code" /><meta name="twitter:creator" content="@guardrail_dev" /><link rel="icon" type="image/png" sizes="16x16" href="/./img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/./img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/./img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/./img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/./img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/./img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/./img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/./img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/./img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/./img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/./img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/./img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/./img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/./img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/./img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/./img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/./img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/./img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/./img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/./img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/./highlight/styles/vs.css" /><link rel="stylesheet" href="/./css/light-style.css" /><script async="async">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-154175369-1' , 'auto');
ga('send', 'pageview');
      </script></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/./" class="brand"><div class="brand-wrapper"></div><span>guardrail</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/" title="Getting Started" class="">Getting Started</a></div> <div class="sidebar-nav-item  "><a href="/docs/java/" title="Java" class="drop-nested">Java</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/docs/java/dropwizard/" title="Dropwizard" class="">Dropwizard</a> <a href="/docs/java/spring-mvc/" title="Spring-MVC" class="">Spring-MVC</a></div></div> <div class="sidebar-nav-item  "><a href="/docs/scala/" title="Scala" class="drop-nested">Scala</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/docs/scala/akka-http" title="akka-http" class="">akka-http</a> <a href="/docs/scala/akka-http-jackson" title="akka-http-jackson" class="">akka-http-jackson</a> <a href="/docs/scala/http4s" title="http4s" class="">http4s</a></div></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/guardrail-dev/guardrail" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/guardrail-dev/guardrail" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="guardrail-dev" data-github-repo="guardrail"><div class="content-wrapper"><section><h1 id="generating-a-server">Generating a Server</h1>

<p>guardrail-generated servers come in two parts: a <code class="language-plaintext highlighter-rouge">Resource</code> and a <code class="language-plaintext highlighter-rouge">Handler</code>. The <code class="language-plaintext highlighter-rouge">Resource</code> contains all the routing logic, accepting a <code class="language-plaintext highlighter-rouge">Handler</code> as an argument to the <code class="language-plaintext highlighter-rouge">route</code> function in order to provide an HTTP service in whichever supported HTTP framework you’re hosting your service in.</p>

<p>The following is an example from the <a href="https://github.com/akka/akka-http">akka-http</a> server generator:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// The `Handler` trait is fully abstracted from the underlying http framework. As a result, with the exception of some</span>
<span class="c1">// structural alterations (`F[_]` instead of `Future[_]` as the return type) the same handlers can be used with</span>
<span class="c1">// different `Resource` implementations from different framework generators. This permits greater compatibility between</span>
<span class="c1">// different frameworks without changing your business logic.</span>
  
<span class="k">trait</span> <span class="nc">UserHandler</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">createUser</span><span class="o">(</span><span class="n">respond</span><span class="k">:</span> <span class="kt">UserResource.CreateUserResponse.</span><span class="k">type</span><span class="o">)(</span><span class="n">body</span><span class="k">:</span> <span class="kt">definitions.User</span><span class="o">)</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">UserResource.CreateUserResponse</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">createUsersWithArrayInput</span><span class="o">(</span><span class="n">respond</span><span class="k">:</span> <span class="kt">UserResource.CreateUsersWithArrayInputResponse.</span><span class="k">type</span><span class="o">)(</span><span class="n">body</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">definitions.User</span><span class="o">])</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">UserResource.CreateUsersWithArrayInputResponse</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">createUsersWithListInput</span><span class="o">(</span><span class="n">respond</span><span class="k">:</span> <span class="kt">UserResource.CreateUsersWithListInputResponse.</span><span class="k">type</span><span class="o">)(</span><span class="n">body</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">definitions.User</span><span class="o">])</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">UserResource.CreateUsersWithListInputResponse</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">loginUser</span><span class="o">(</span><span class="n">respond</span><span class="k">:</span> <span class="kt">UserResource.LoginUserResponse.</span><span class="k">type</span><span class="o">)(</span><span class="n">username</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">password</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">UserResource.LoginUserResponse</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">logoutUser</span><span class="o">(</span><span class="n">respond</span><span class="k">:</span> <span class="kt">UserResource.LogoutUserResponse.</span><span class="k">type</span><span class="o">)()</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">UserResource.LogoutUserResponse</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">getUserByName</span><span class="o">(</span><span class="n">respond</span><span class="k">:</span> <span class="kt">UserResource.GetUserByNameResponse.</span><span class="k">type</span><span class="o">)(</span><span class="n">username</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">UserResource.GetUserByNameResponse</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">updateUser</span><span class="o">(</span><span class="n">respond</span><span class="k">:</span> <span class="kt">UserResource.UpdateUserResponse.</span><span class="k">type</span><span class="o">)(</span><span class="n">username</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">body</span><span class="k">:</span> <span class="kt">definitions.User</span><span class="o">)</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">UserResource.UpdateUserResponse</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">respond</span><span class="k">:</span> <span class="kt">UserResource.DeleteUserResponse.</span><span class="k">type</span><span class="o">)(</span><span class="n">username</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">UserResource.DeleteUserResponse</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">UserResource</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">routes</span><span class="o">(</span><span class="n">handler</span><span class="k">:</span> <span class="kt">UserHandler</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">mat</span><span class="k">:</span> <span class="kt">akka.stream.Materializer</span><span class="o">)</span><span class="k">:</span> <span class="kt">Route</span> <span class="o">=</span> <span class="o">{</span>
    <span class="o">{</span>
      <span class="nf">path</span><span class="o">(</span><span class="s">"v2"</span> <span class="o">/</span> <span class="s">"user"</span><span class="o">)(</span><span class="nf">post</span><span class="o">(</span><span class="nf">entity</span><span class="o">(</span><span class="n">as</span><span class="o">[</span><span class="kt">definitions.User</span><span class="o">](</span><span class="n">createUserDecoder</span><span class="o">)).</span><span class="py">apply</span><span class="o">(</span><span class="n">body</span> <span class="k">=&gt;</span> <span class="nf">complete</span><span class="o">(</span><span class="nv">handler</span><span class="o">.</span><span class="py">createUser</span><span class="o">(</span><span class="nc">CreateUserResponse</span><span class="o">)(</span><span class="n">body</span><span class="o">)))))</span>
    <span class="o">}</span> <span class="o">~</span> <span class="o">{</span>
      <span class="nf">path</span><span class="o">(</span><span class="s">"v2"</span> <span class="o">/</span> <span class="s">"user"</span> <span class="o">/</span> <span class="s">"createWithArray"</span><span class="o">)(</span><span class="nf">post</span><span class="o">(</span><span class="nf">entity</span><span class="o">(</span><span class="n">as</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">definitions.User</span><span class="o">]](</span><span class="n">createUsersWithArrayInputDecoder</span><span class="o">)).</span><span class="py">apply</span><span class="o">(</span><span class="n">body</span> <span class="k">=&gt;</span> <span class="nf">complete</span><span class="o">(</span><span class="nv">handler</span><span class="o">.</span><span class="py">createUsersWithArrayInput</span><span class="o">(</span><span class="nc">CreateUsersWithArrayInputResponse</span><span class="o">)(</span><span class="n">body</span><span class="o">)))))</span>
    <span class="o">}</span> <span class="o">~</span> <span class="o">{</span>
      <span class="nf">path</span><span class="o">(</span><span class="s">"v2"</span> <span class="o">/</span> <span class="s">"user"</span> <span class="o">/</span> <span class="s">"createWithList"</span><span class="o">)(</span><span class="nf">post</span><span class="o">(</span><span class="nf">entity</span><span class="o">(</span><span class="n">as</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">definitions.User</span><span class="o">]](</span><span class="n">createUsersWithListInputDecoder</span><span class="o">)).</span><span class="py">apply</span><span class="o">(</span><span class="n">body</span> <span class="k">=&gt;</span> <span class="nf">complete</span><span class="o">(</span><span class="nv">handler</span><span class="o">.</span><span class="py">createUsersWithListInput</span><span class="o">(</span><span class="nc">CreateUsersWithListInputResponse</span><span class="o">)(</span><span class="n">body</span><span class="o">)))))</span>
    <span class="o">}</span> <span class="o">~</span> <span class="o">{</span>
      <span class="nf">path</span><span class="o">(</span><span class="s">"v2"</span> <span class="o">/</span> <span class="s">"user"</span> <span class="o">/</span> <span class="s">"login"</span><span class="o">)(</span><span class="nf">get</span><span class="o">((</span><span class="nf">parameter</span><span class="o">(</span><span class="nc">Symbol</span><span class="o">(</span><span class="s">"username"</span><span class="o">).</span><span class="py">as</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="nv">stringyJsonUnmarshaller</span><span class="o">.</span><span class="py">andThen</span><span class="o">(</span><span class="n">unmarshallJson</span><span class="o">[</span><span class="kt">String</span><span class="o">])))</span> <span class="o">&amp;</span> <span class="nf">parameter</span><span class="o">(</span><span class="nc">Symbol</span><span class="o">(</span><span class="s">"password"</span><span class="o">).</span><span class="py">as</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="nv">stringyJsonUnmarshaller</span><span class="o">.</span><span class="py">andThen</span><span class="o">(</span><span class="n">unmarshallJson</span><span class="o">[</span><span class="kt">String</span><span class="o">])))).</span><span class="py">apply</span><span class="o">((</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nf">discardEntity</span><span class="o">(</span><span class="nf">complete</span><span class="o">(</span><span class="nv">handler</span><span class="o">.</span><span class="py">loginUser</span><span class="o">(</span><span class="nc">LoginUserResponse</span><span class="o">)(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">))))))</span>
    <span class="o">}</span> <span class="o">~</span> <span class="o">{</span>
      <span class="nf">path</span><span class="o">(</span><span class="s">"v2"</span> <span class="o">/</span> <span class="s">"user"</span> <span class="o">/</span> <span class="s">"logout"</span><span class="o">)(</span><span class="nf">get</span><span class="o">(</span><span class="nf">discardEntity</span><span class="o">(</span><span class="nf">complete</span><span class="o">(</span><span class="nv">handler</span><span class="o">.</span><span class="py">logoutUser</span><span class="o">(</span><span class="nc">LogoutUserResponse</span><span class="o">)()))))</span>
    <span class="o">}</span> <span class="o">~</span> <span class="o">{</span>
      <span class="nf">path</span><span class="o">(</span><span class="s">"v2"</span> <span class="o">/</span> <span class="s">"user"</span> <span class="o">/</span> <span class="nc">Segment</span><span class="o">).</span><span class="py">apply</span><span class="o">(</span><span class="n">username</span> <span class="k">=&gt;</span> <span class="nf">get</span><span class="o">(</span><span class="nf">discardEntity</span><span class="o">(</span><span class="nf">complete</span><span class="o">(</span><span class="nv">handler</span><span class="o">.</span><span class="py">getUserByName</span><span class="o">(</span><span class="nc">GetUserByNameResponse</span><span class="o">)(</span><span class="n">username</span><span class="o">)))))</span>
    <span class="o">}</span> <span class="o">~</span> <span class="o">{</span>
      <span class="nf">path</span><span class="o">(</span><span class="s">"v2"</span> <span class="o">/</span> <span class="s">"user"</span> <span class="o">/</span> <span class="nc">Segment</span><span class="o">).</span><span class="py">apply</span><span class="o">(</span><span class="n">username</span> <span class="k">=&gt;</span> <span class="nf">put</span><span class="o">(</span><span class="nf">entity</span><span class="o">(</span><span class="n">as</span><span class="o">[</span><span class="kt">definitions.User</span><span class="o">](</span><span class="n">updateUserDecoder</span><span class="o">)).</span><span class="py">apply</span><span class="o">(</span><span class="n">body</span> <span class="k">=&gt;</span> <span class="nf">complete</span><span class="o">(</span><span class="nv">handler</span><span class="o">.</span><span class="py">updateUser</span><span class="o">(</span><span class="nc">UpdateUserResponse</span><span class="o">)(</span><span class="n">username</span><span class="o">,</span> <span class="n">body</span><span class="o">)))))</span>
    <span class="o">}</span> <span class="o">~</span> <span class="o">{</span>
      <span class="nf">path</span><span class="o">(</span><span class="s">"v2"</span> <span class="o">/</span> <span class="s">"user"</span> <span class="o">/</span> <span class="nc">Segment</span><span class="o">).</span><span class="py">apply</span><span class="o">(</span><span class="n">username</span> <span class="k">=&gt;</span> <span class="nf">delete</span><span class="o">(</span><span class="nf">discardEntity</span><span class="o">(</span><span class="nf">complete</span><span class="o">(</span><span class="nv">handler</span><span class="o">.</span><span class="py">deleteUser</span><span class="o">(</span><span class="nc">DeleteUserResponse</span><span class="o">)(</span><span class="n">username</span><span class="o">)))))</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="n">`...`</span>
<span class="o">}</span>
</code></pre></div></div>

<p>As all parameters are provided as arguments to the function stubs in the trait, there’s no concern of forgetting to extract a query string parameter, introducing a typo in a form parameter name, or forgetting to close the bytestream for the streaming HTTP Request.</p>

<p>(See it in action: <a href="https://github.com/guardrail-dev/guardrail-sample-sbt-akkahttp">guardrail-dev/guardrail-sample-sbt-akkahttp</a>)</p>

<h2 id="separation-of-business-logic">Separation of business logic</h2>

<p>Providing an implementation of a function with a well-defined set of inputs and outputs is natural for any developer. By reducing the scope of the interface a developer writes against, implementations are more clear and concise.</p>

<p>Furthermore, by providing business logic as an implementation of an abstract class, unit tests can test the routing layer and business logic independently, by design.</p>

<h2 id="api-structure-slip-is-impossible">API structure slip is impossible</h2>

<p>As parameters are explicitly provided as arguments to functions in <code class="language-plaintext highlighter-rouge">Handler</code>s, any alteration to parameters constitute a new function interface that must be implemented. As a result, if providing an implementation for an externally managed specification, the compiler informs when a previously written function is no longer sufficient.</p>

<p>By representing different response codes and structures as members of a sealed trait, it’s impossible to return a structure that violates the specification, even for less frequently used response codes.</p>

<p>Finally, describing an endpoint in your specification without providing an implementation for it is a compiler error. This prevents reduction of functionality due to refactors, human error, or miscommunication with other teams.</p>

<h2 id="extracting-custom-data-from-a-request">Extracting custom data from a request</h2>

<p>In some cases, you may wish to extract data from a request and inject it into your handler, without specifying the extracted data in the OpenAPI definition. Common use cases include integrating with existing <code class="language-plaintext highlighter-rouge">Directive</code>s, accessing underlying data provided by akka-http but without a direct analog in OpenAPI, as well as providing an escape hatch to inject functionality expressed via akka-http’s <code class="language-plaintext highlighter-rouge">Directive</code> directly into the Akka HTTP routes generated by guardrail.</p>

<p>If using the guardrail CLI, supply <code class="language-plaintext highlighter-rouge">--custom-extraction</code> when generating your server in order to get this functionality.</p>

<p>Once the feature is enabled, the generated code from the above example is modified to look like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">UserHandler</span><span class="o">[</span><span class="kt">-E</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">createUser</span><span class="o">(</span><span class="n">respond</span><span class="k">:</span> <span class="kt">UserResource.CreateUserResponse.</span><span class="k">type</span><span class="o">)(</span><span class="n">body</span><span class="k">:</span> <span class="kt">definitions.User</span><span class="o">)(</span><span class="n">extracted</span><span class="k">:</span> <span class="kt">E</span><span class="o">)</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">UserResource.CreateUserResponse</span><span class="o">]</span>
  <span class="c1">// ...</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">UserResource</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">routes</span><span class="o">[</span><span class="kt">E</span><span class="o">](</span><span class="n">handler</span><span class="k">:</span> <span class="kt">UserHandler</span><span class="o">,</span> <span class="n">customExtract</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="nc">Directive1</span><span class="o">[</span><span class="kt">E</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">mat</span><span class="k">:</span> <span class="kt">akka.stream.Materializer</span><span class="o">)</span><span class="k">:</span> <span class="kt">Route</span> <span class="o">=</span> <span class="o">{</span>
    <span class="c1">// ...</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>You may now provide a function that accepts the <code class="language-plaintext highlighter-rouge">operationId</code> of the route, and returns a <code class="language-plaintext highlighter-rouge">Directive1[E]</code>, where, <code class="language-plaintext highlighter-rouge">E</code> is an arbitrary type that will be passed through to your handlers. The <code class="language-plaintext highlighter-rouge">Directive1[E]</code> will be injected into the generated routes <em>after</em> the path and method <code class="language-plaintext highlighter-rouge">Directive</code>s.</p>

<p><em>Note:</em> If you have any <code class="language-plaintext highlighter-rouge">Directive</code> with an arity different to <code class="language-plaintext highlighter-rouge">Directive1</code> (for instance, <code class="language-plaintext highlighter-rouge">Directive0</code> or <code class="language-plaintext highlighter-rouge">Directive5</code>) you must convert it into a <code class="language-plaintext highlighter-rouge">Directive1</code> via <code class="language-plaintext highlighter-rouge">myCoolDirective.tmap(Tuple1(_))</code> or similar. This is done to provide a consistent user experience, without the added complexity of the so-called “magnet pattern”.</p>

<p>For example, to extract an <code class="language-plaintext highlighter-rouge">X-User-Id</code> header value from an incoming request, your code might look like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UserApi</span> <span class="k">extends</span> <span class="nc">UserHandler</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="nf">createUser</span><span class="o">(</span><span class="n">respond</span><span class="k">:</span> <span class="kt">UserResource.CreateUserResponse.</span><span class="k">type</span><span class="o">)(</span><span class="n">body</span><span class="k">:</span> <span class="kt">definitions.User</span><span class="o">)(</span><span class="n">userIdHeader</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">UserResource.CreateUserResponse</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"The supplied X-User-Id header is: $userIdHeader"</span><span class="o">)</span>
    <span class="o">???</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">extractXUserId</span> <span class="k">=</span> <span class="o">(</span><span class="n">operationId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nf">headerValueByName</span><span class="o">(</span><span class="s">"X-User-Id"</span><span class="o">)</span> <span class="c1">// Directive from Akka HTTP</span>

<span class="k">val</span> <span class="nv">userRoutes</span> <span class="k">=</span> <span class="nv">UserResource</span><span class="o">.</span><span class="py">routes</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserApi</span><span class="o">,</span> <span class="n">extractXUserId</span><span class="o">)</span>

</code></pre></div></div>

<p>Because <code class="language-plaintext highlighter-rouge">E</code> is an arbitrary type, you may extract anything, including the full <code class="language-plaintext highlighter-rouge">HttpRequest</code> itself. Multiple values may be extracted using tuples. If you do not wish to extract anything, perhaps because the <code class="language-plaintext highlighter-rouge">Directive</code> acts as a gate which <code class="language-plaintext highlighter-rouge">pass</code>es some requests and <code class="language-plaintext highlighter-rouge">reject</code>s others, simply provide <code class="language-plaintext highlighter-rouge">String =&gt; Directive1[Unit]</code> and write your handler implementation to extend <code class="language-plaintext highlighter-rouge">Handler[Unit]</code>.</p>

<h2 id="generating-test-only-real-server-mocks-for-unit-tests">Generating test-only (real) server mocks for unit tests</h2>

<p>Often, we’ll also want to have mock HTTP clients for use in unit tests. Mocking requires stringent adherence to the specification, otherwise our mock clients are unrepresentative of the production systems they are intending to mock. The following is an example of a “mock” HTTP Client generated by guardrail; it speaks real HTTP, though doesn’t need to bind to a port in order to run. This permits parallelized tests to be run without concern of port contention.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">userRoutes</span><span class="k">:</span> <span class="kt">Route</span> <span class="o">=</span> <span class="nv">UserResource</span><span class="o">.</span><span class="py">routes</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserHandler</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="nf">getUserByName</span><span class="o">(</span><span class="n">respond</span><span class="k">:</span> <span class="kt">UserResource.getUserByNameResponse.</span><span class="k">type</span><span class="o">)(</span><span class="n">username</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">UserResource.getUserByNameResponse</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nf">if</span> <span class="o">(</span><span class="n">username</span> <span class="o">==</span> <span class="s">"foo"</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">Future</span><span class="o">.</span><span class="py">successful</span><span class="o">(</span><span class="nv">respond</span><span class="o">.</span><span class="py">OK</span><span class="o">(</span><span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="k">=</span><span class="nc">Some</span><span class="o">(</span><span class="mi">1234L</span><span class="o">),</span> <span class="n">username</span><span class="k">=</span><span class="nc">Some</span><span class="o">(</span><span class="s">"foo"</span><span class="o">))))</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="nv">Future</span><span class="o">.</span><span class="py">successful</span><span class="o">(</span><span class="nv">respond</span><span class="o">.</span><span class="py">NotFound</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">})</span>
<span class="k">val</span> <span class="nv">userHttpClient</span><span class="k">:</span> <span class="kt">HttpRequest</span> <span class="o">=&gt;</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">HttpResponse</span><span class="o">]</span> <span class="k">=</span> <span class="nv">Route</span><span class="o">.</span><span class="py">toFunction</span><span class="o">(</span><span class="n">userRoutes</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">userClient</span><span class="k">:</span> <span class="kt">UserClient</span> <span class="o">=</span> <span class="nv">UserClient</span><span class="o">.</span><span class="py">httpCLient</span><span class="o">(</span><span class="n">userHttpClient</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">getUserResponse</span><span class="k">:</span> <span class="kt">EitherT</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">Either</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">HttpResponse</span><span class="o">]</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="nv">userClient</span><span class="o">.</span><span class="py">getUserByName</span><span class="o">(</span><span class="s">"foo"</span><span class="o">).</span><span class="py">map</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">fold</span><span class="o">(</span><span class="n">user</span> <span class="k">=&gt;</span> <span class="n">user</span><span class="o">))</span>
<span class="k">val</span> <span class="nv">user</span><span class="k">:</span> <span class="kt">User</span> <span class="o">=</span> <span class="nv">getUserResponse</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">futureValue</span><span class="o">.</span><span class="py">right</span><span class="o">.</span><span class="py">value</span> <span class="c1">// Unwraps `User(id=Some(1234L), username=Some("foo"))` using scalatest's `ScalaFutures` and `EitherValues` unwrappers.</span>
</code></pre></div></div>

<p>This strategy of mocking ensures we follow the spec, even when the specification changes. This means not only more robust tests, but also tests that communicate failures via compiler errors instead of at runtime. Having a clear separation of where errors can come from permits trusting our tests more. If the tests compile, any and all errors that occur are in the domain of business logic.</p>

<p>One other strategy for testing non-guardrail generated clients is to bind <code class="language-plaintext highlighter-rouge">userRoutes</code> from above to a port, run tests that use hand-rolled or vendor-supplied HTTP clients, then unbind the port when the test ends:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">binding</span><span class="k">:</span> <span class="kt">ServerBinding</span> <span class="o">=</span>
  <span class="nc">Http</span><span class="o">().</span><span class="py">bindAndHandle</span><span class="o">(</span><span class="n">userRoutes</span><span class="o">,</span> <span class="s">"localhost"</span><span class="o">,</span> <span class="mi">1234</span><span class="o">).</span><span class="py">futureValue</span>

<span class="c1">// run tests</span>

<span class="nv">binding</span><span class="o">.</span><span class="py">unbind</span><span class="o">().</span><span class="py">futureValue</span>
</code></pre></div></div>

<h2 id="a-note-about-scalatest-integration">A note about scalatest integration</h2>

<h3 id="akka-http">akka-http</h3>

<p>The default <code class="language-plaintext highlighter-rouge">ExceptionHandler</code> in akka-http swallows exceptions, so if you intend to <code class="language-plaintext highlighter-rouge">fail()</code> tests from inside guardrail-generated HTTP Servers, you’ll likely want to have the following implicit in scope:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">implicit</span> <span class="k">def</span> <span class="nf">exceptionHandler</span><span class="k">:</span> <span class="kt">ExceptionHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExceptionHandler</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">withFallback</span><span class="o">(</span><span class="n">that</span><span class="k">:</span> <span class="kt">ExceptionHandler</span><span class="o">)</span><span class="k">:</span> <span class="kt">ExceptionHandler</span> <span class="o">=</span> <span class="k">this</span>
  <span class="k">def</span> <span class="nf">seal</span><span class="o">(</span><span class="n">settings</span><span class="k">:</span> <span class="kt">RoutingSettings</span><span class="o">)</span><span class="k">:</span> <span class="kt">ExceptionHandler</span> <span class="o">=</span> <span class="k">this</span>

  <span class="k">def</span> <span class="nf">isDefinedAt</span><span class="o">(</span><span class="n">error</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span> <span class="k">=</span> <span class="nv">error</span><span class="o">.</span><span class="py">isInstanceOf</span><span class="o">[</span><span class="kt">org.scalatest.TestFailedException</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">apply</span><span class="o">(</span><span class="n">error</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span> <span class="k">=</span> <span class="k">throw</span> <span class="n">error</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This passes all <code class="language-plaintext highlighter-rouge">TestFailedExceptions</code> through to the underlying infrastructure. In our tests, when we call:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">userClient</span><span class="k">:</span> <span class="kt">UserClient</span> <span class="o">=</span> <span class="nv">UserClient</span><span class="o">.</span><span class="py">httpCLient</span><span class="o">(</span><span class="n">userHttpClient</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">getUserResponse</span><span class="k">:</span> <span class="kt">EitherT</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">Either</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">HttpResponse</span><span class="o">]</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="nv">userClient</span><span class="o">.</span><span class="py">getUserByName</span><span class="o">(</span><span class="s">"foo"</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">user</span><span class="k">:</span> <span class="kt">User</span> <span class="o">=</span> <span class="nv">getUserResponse</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">fold</span><span class="o">(</span><span class="n">user</span> <span class="k">=&gt;</span> <span class="n">user</span><span class="o">)).</span><span class="py">value</span><span class="o">.</span><span class="py">futureValue</span><span class="o">.</span><span class="py">right</span><span class="o">.</span><span class="py">value</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">futureValue</code> will raise the <code class="language-plaintext highlighter-rouge">TestFailedException</code> with the relevant stack trace.</p>

<p><span style="float: left"><a href="sample-api-specification">Prev: Sample API specification</a></span>
<span style="float: right"><a href="generating-clients">Next: Generating clients</a></span></p>
</section></div></div></div></div><script src="/./highlight/highlight.pack.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/yaml.min.js"></script><script src="/./lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash','yaml','scala']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/./js/search.js"></script><script src="/./js/docs.js"></script></body></html>